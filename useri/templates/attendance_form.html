<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance and Training Sessions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.min.js"></script>
    <style>
        body, html {
            height: 100%;
        }
        .container {
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }
        .card {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
        }
        .card-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .table-responsive {
            flex-grow: 1;
            overflow-y: auto;
        }
        #qrVideo {
            width: 100%;
            max-width: 400px;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row h-100">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <h1 class="card-title text-center mb-3">Attendance Lookup</h1>
                        
                        <form id="attendanceForm" method="POST" action="{% url 'attendance_view' %}" class="mb-3">
                            {% csrf_token %}
                            <div class="mb-2">
                                <label for="username" class="form-label">Enter Username:</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Submit</button>
                        </form>

                        <div class="mb-3">
                            <button id="startCamera" class="btn btn-secondary w-100 mb-2">Start QR Scanner</button>
                            <select id="cameraSelect" class="form-select mb-2" style="display: none;">
                                <!-- Camera options will be added here -->
                            </select>
                            <video id="qrVideo" style="display: none;"></video>
                        </div>

                        <div id="resultSection" class="flex-grow-1 d-flex flex-column" style="display: none;">
                            <h2 class="text-center mb-2">Training Sessions Attended</h2>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trainingList">
                                        <!-- Training sessions will be dynamically added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('attendanceForm').addEventListener('submit', fetchAttendance);
        document.getElementById('startCamera').addEventListener('click', startQRScanner);

        let videoElem = document.getElementById('qrVideo');
        let cameraSelect = document.getElementById('cameraSelect');
        let scanning = false;

        function fetchAttendance(event) {
            event.preventDefault();
            const form = document.getElementById('attendanceForm');
            const formData = new FormData(form);
            axios.post(form.action, formData, {
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                const data = response.data;
                if (data.status === 'success') {
                    displayTrainings(data.training_sessions);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('There was an error!', error);
            });
        }

        async function startQRScanner() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                cameraSelect.innerHTML = '';
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });

                cameraSelect.style.display = 'block';
                videoElem.style.display = 'block';

                cameraSelect.addEventListener('change', startScanning);
                await startScanning();
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Unable to access the camera. Please make sure you have granted the necessary permissions.');
            }
        }

        async function startScanning() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: cameraSelect.value }
                });
                videoElem.srcObject = stream;
                videoElem.play();
                scanning = true;
                scanQRCode();
            } catch (error) {
                console.error('Error starting video stream:', error);
                alert('Failed to start the camera. Please try again or use a different camera.');
            }
        }

        function scanQRCode() {
            if (videoElem.readyState === videoElem.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = videoElem.videoWidth;
                canvas.height = videoElem.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoElem, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    console.log("Found QR code", code.data);
                    document.getElementById('username').value = code.data;
                    fetchAttendance(new Event('submit'));
                    stopScanning();
                }
            }

            if (scanning) {
                requestAnimationFrame(scanQRCode);
            }
        }

        function stopScanning() {
            scanning = false;
            if (videoElem.srcObject) {
                videoElem.srcObject.getTracks().forEach(track => track.stop());
            }
            videoElem.style.display = 'none';
            cameraSelect.style.display = 'none';
        }

        function displayTrainings(trainings) {
            const tableBody = document.getElementById('trainingList');
            tableBody.innerHTML = ''; // Clear previous entries
        
            trainings.forEach(training => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${training.title}</td>
                    <td>${formatDate(training.date)}</td>
                `;
                tableBody.appendChild(row);
            });

            document.getElementById('resultSection').style.display = 'block';
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
    </script>
</body>
</html>