{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-3">
      <h2>Training Details</h2>
      <div class="mb-3">
        <strong>Training Name:</strong> 
        {% if training.training_programme %}
          {{ training.training_programme.title }}
        {% else %}
          {{ training.custom_training_programme }}
        {% endif %}
      </div>
      <div class="mb-3">
        <strong>Venue:</strong> 
        {% if training.venue %}
          {{ training.venue.name }}
        {% else %}
          Online
        {% endif %}
      </div>
      <div class="mb-3">
        <strong>Trainer:</strong> 
        {% if training.trainer %}
          {{ training.trainer.name }}
        {% else %}
          N/A
        {% endif %}
      </div>
      <h2>Set Training Date and Time</h2>
      <form method="post">
        {% csrf_token %}
        {% if venue_type != 'Online' %}
        <div class="mb-3" id="date-field">
          {{ form.date.label_tag }} {{ form.date }}
        </div>
        <div class="mb-3" id="from-time-field">
          {{ form.from_time.label_tag }} {{ form.from_time }}
        </div>
        <div class="mb-3" id="to-time-field">
          {{ form.to_time.label_tag }} {{ form.to_time }}
        </div>
        {% else %}
        <div class="mb-3" id="deadline-field">
          {{ form.deadline_to_complete.label_tag }} {{ form.deadline_to_complete }}
        </div>
        {% endif %}
        <button type="submit" class="btn btn-primary">Save</button>
        <a href="{% url 'create_training' %}" class="btn btn-secondary">Back</a>
      </form>
    </div>

    <div class="col-md-3">
      <h2>Departments</h2>
      <div class="list-group" id="department-list" style="height: 75vh; overflow-y: auto;">
        {% for department in departments %}
        <a href="#" class="list-group-item list-group-item-action department-item" data-department-id="{{ department.id }}">
          {{ department.name }}
        </a>
        {% endfor %}
      </div>
    </div>

    <div class="col-md-6">
      <h2>Department Details</h2>
      <div id="department-details" style="height: 75vh; overflow-y: auto;">
        <!-- Department details will be populated here -->
      </div>
    </div>
  </div>
</div>

<style>
  .selected-users-list {
    max-height: 85vh;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
  }
</style>


<script>
  $(document).ready(function() {
    function updateSelectedUsersList() {
      const selectedUsers = $('.user-checkbox:checked');
      const selectedUsersList = $('#selected-users-list');
      const totalSelected = $('#total-selected');
      selectedUsersList.empty();
      let totalCount = 0;

      selectedUsers.each(function() {
        const userName = $(this).data('name');
        const userId = $(this).data('id');
        selectedUsersList.append(`<div>${userName} (ID: ${userId})</div>`);
        totalCount++;
      });

      totalSelected.text(totalCount);
    }

    function loadDepartmentDetails(departmentId) {
      const trainingId = '{{ training.id }}';
      $.ajax({
        url: `{% url 'get_department_details' %}`,
        method: 'GET',
        data: {
          department_id: departmentId,
          training_id: trainingId
        },
        success: function(data) {
          const department = data.department;
          const head = department.head;
          const associates = department.associates;
          const employees = department.employees;

          let detailsHtml = `
            <h4>Department Head: ${head.employee_name} (${head.username})</h4>
            <h4>Associates</h4>
            <input type="checkbox" id="select-all-associates"> Select All
            <ul class="list-group">
          `;
          associates.forEach(associate => {
            detailsHtml += `
              <li class="list-group-item">
                <input type="checkbox" class="associate-checkbox user-checkbox" data-id="${associate.id}" data-name="${associate.employee_name}" ${associate.selected ? 'checked' : ''}>
                ${associate.employee_name} - ${associate.username}
              </li>
            `;
          });
          detailsHtml += `</ul><h4>Employees</h4><input type="checkbox" id="select-all-employees"> Select All<ul class="list-group">`;
          employees.forEach(employee => {
            detailsHtml += `
              <li class="list-group-item">
                <input type="checkbox" class="employee-checkbox user-checkbox" data-id="${employee.id}" data-name="${employee.employee_name}" ${employee.selected ? 'checked' : ''}>
                ${employee.employee_name} (${employee.username})
              </li>
            `;
          });
          detailsHtml += '</ul>';

          $('#department-details').html(detailsHtml);
          $('.user-checkbox').change(updateSelectedUsersList);
          $('#select-all-associates').change(function() {
            $('.associate-checkbox').prop('checked', this.checked);
            updateSelectedUsersList();
          });
          $('#select-all-employees').change(function() {
            $('.employee-checkbox').prop('checked', this.checked);
            updateSelectedUsersList();
          });
        },
        error: function() {
          $('#department-details').html('<p>Error loading department details.</p>');
        }
      });
    }

    $('.department-item').click(function(e) {
      e.preventDefault();
      const departmentId = $(this).data('department-id');
      loadDepartmentDetails(departmentId);
    });

    updateSelectedUsersList(); // Initial call to populate selected users list
  });
</script>
{% endblock %}
